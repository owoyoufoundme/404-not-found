<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gacha Room</title>
<style>
body {
  margin: 0;
  font-family: "Patrick Hand", cursive;
  background: linear-gradient(#ffe6f0, #fff);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#topBar {
  position: fixed;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20px;
  font-size: 18px;
}

.card {
  background: white;
  border-radius: 20px;
  padding: 30px;
  width: 420px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

h1 { margin-top: 0; }
button {
  font-family: inherit;
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  background: #ff9ecb;
  cursor: pointer;
  font-size: 16px;
}
button:hover { background: #ff7fb5; }
input {
  font-family: inherit;
  padding: 8px;
  width: 80%;
  margin-top: 10px;
  border-radius: 10px;
  border: 2px solid #ff9ecb;
  font-size: 16px;
}
#result { margin-top: 15px; font-size: 18px; }
#history {
  margin-top: 20px;
  text-align: left;
  font-size: 14px;
  max-height: 120px;
  overflow-y: auto;
  background: #fff5fa;
  padding: 10px;
  border-radius: 12px;
}
.hidden { display: none; }

/* Loading animation */
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 28px;
  background: rgba(255,255,255,0.9);
  padding: 20px 30px;
  border-radius: 20px;
  display: none;
  text-align: center;
}

/* Reward popup */
#rewardPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 20px;
  display: none;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  z-index: 10000;
}
#rewardPopup h2 { margin: 0 0 10px 0; }
#rewardPopup img { max-width: 200px; border-radius: 12px; }
</style>
</head>
<body>

<div id="topBar">
  <div id="playerNameDisplay">Player: </div>
  <div id="coinsDisplay">ðŸª™ 0</div>
</div>

<div class="card">

  <!-- NAME SETUP -->
  <div id="nameSetup">
    <h1>Welcome â™¡</h1>
    <p>Enter your name:</p>
    <input id="playerNameInput" placeholder="your name">
    <br><br>
    <button onclick="registerName()">Enter</button>
  </div>

  <!-- GACHA UI -->
  <div id="gachaUI" class="hidden">
    <h1 id="welcomeText"></h1>
    <button onclick="rollGacha()">ðŸŽ° Roll (10 coins)</button>
    <div id="result"></div>
    <h3>ðŸ“œ Gacha History</h3>
    <div id="history"></div>
  </div>

</div>

<!-- Loading Animation -->
<div id="loading">Rolling...</div>

<!-- Reward Popup -->
<div id="rewardPopup">
  <h2 id="rewardTitle"></h2>
  <img id="rewardImage" src="">
  <br><br>
  <button onclick="closeReward()">Close</button>
</div>

<!-- Cutscene Video -->
<video id="cutsceneVideo" class="hidden" width="80%" height="50%" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);" autoplay></video>

<audio id="rewardSound"></audio>

<script>
// ---------- STATE ----------
const GACHA_COST = 10;
let player = { name:"", coins:0, history:[] };
const gachaPool = [
  { id:"meme_001", type:"meme", name:"The Stare", rarity:"common", url:"", video:"commonVideo.mp4", sound:"common.mp3" },
  { id:"meme_002", type:"meme", name:"Cursed Smile", rarity:"rare", url:"", video:"rareVideo.mp4", sound:"rare.mp3" },
  { id:"legend_001", type:"legendary", name:"Golden Ticket", rarity:"legendary", url:"", video:"legendVideo.mp4", sound:"legend.mp3" }
];

// ---------- INIT ----------
loadPlayer();

function loadPlayer() {
  const savedName = localStorage.getItem("currentPlayerName");
  const allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  if (savedName) {
    const savedPlayer = allPlayers.find(p => p.name === savedName);
    if (savedPlayer) {
      player = savedPlayer;
      showGacha();
      return;
    }
  }
  document.getElementById("nameSetup").classList.remove("hidden");
}

function savePlayer() {
  let allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  const idx = allPlayers.findIndex(p => p.name===player.name);
  if(idx>-1) allPlayers[idx]=player;
  else allPlayers.push(player);
  localStorage.setItem("gachaPlayers", JSON.stringify(allPlayers));
  localStorage.setItem("currentPlayerName", player.name);
  updateUI();
}

// ---------- NAME ----------
function registerName() {
  const name = document.getElementById("playerNameInput").value.trim();
  if (!name) return;
  player.name = name;
  player.coins = 50; // start coins
  player.history = [];
  savePlayer();
  showGacha();
}

// ---------- UI ----------
function showGacha() {
  document.getElementById("nameSetup").classList.add("hidden");
  document.getElementById("gachaUI").classList.remove("hidden");
  document.getElementById("welcomeText").innerText = `Hi ${player.name} â™¡`;
  document.getElementById("playerNameDisplay").innerText = player.name;
  updateUI();
}

function updateUI() {
  document.getElementById("coinsDisplay").innerText = `ðŸª™ ${player.coins}`;
  document.getElementById("history").innerHTML = player.history.map(h=>`â€¢ ${h.name} (${h.rarity})`).join("<br>");
}

// ---------- GACHA ----------
function rollGacha() {
  if(player.coins<GACHA_COST){ alert("Not enough coins!"); return; }
  player.coins -= GACHA_COST;
  updateUI();
  
  const loading = document.getElementById("loading");
  loading.style.display="block";

  const pull = gachaPool[Math.floor(Math.random()*gachaPool.length)];

  // wait 1.5s for "loading" effect
  setTimeout(()=>playCutscene(pull), 1500);
}

function playCutscene(item) {
  const video = document.getElementById("cutsceneVideo");
  video.src = item.video; // cutscene video for rarity
  video.classList.remove("hidden");
  video.play();

  video.onended = ()=>{
    video.classList.add("hidden");
    showReward(item);
  };
}

function showReward(item) {
  document.getElementById("loading").style.display="none";
  const popup = document.getElementById("rewardPopup");
  document.getElementById("rewardTitle").innerText = item.name;
  document.getElementById("rewardImage").src = item.url;
  
  const sound = document.getElementById("rewardSound");
  sound.src = item.sound;
  sound.play();

  popup.style.display="block";

  player.history.unshift(item);
  savePlayer();
}

function closeReward() {
  document.getElementById("rewardPopup").style.display="none";
}
</script>
</body>
</html>
