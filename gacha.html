<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gacha Room</title>
<style>
body {
  margin: 0;
  font-family: "Patrick Hand", cursive;
  background: linear-gradient(#ffe6f0, #fff);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

#topBar {
  position: fixed;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20px;
  font-size: 18px;
}

.card {
  background: white;
  border-radius: 20px;
  padding: 30px;
  width: 420px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

h1 { margin-top: 0; }
button {
  font-family: inherit;
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  background: #ff9ecb;
  cursor: pointer;
  font-size: 16px;
}
button:hover { background: #ff7fb5; }
input {
  font-family: inherit;
  padding: 8px;
  width: 80%;
  margin-top: 10px;
  border-radius: 10px;
  border: 2px solid #ff9ecb;
  font-size: 16px;
}
#result { margin-top: 15px; font-size: 18px; }
#history {
  margin-top: 20px;
  text-align: left;
  font-size: 14px;
  max-height: 120px;
  overflow-y: auto;
  background: #fff5fa;
  padding: 10px;
  border-radius: 12px;
}
.hidden { display: none; }

/* Loading animation */
#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 28px;
  background: rgba(255,255,255,0.9);
  padding: 20px 30px;
  border-radius: 20px;
  display: none;
  text-align: center;
}

/* Reward popup */
#rewardPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 20px;
  display: none;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  z-index: 10000;
}
#rewardPopup h2 { margin: 0 0 10px 0; }
#rewardPopup img { max-width: 200px; border-radius: 12px; }
</style>
</head>
<body>

<div id="topBar">
  <div id="playerNameDisplay">Player: â€”</div>
  <div style="display:flex; align-items:center; gap:10px;">
    <span id="coinsDisplay">ðŸª™ 0</span>
    <button onclick="showCodeBox()">Enter Code</button>
  </div>
</div>

<!-- Code Popup -->
<div id="codeBox" class="hidden" style="
  position: fixed;
  top: 50px;
  right: 20px;
  background: #fff5fa;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  z-index: 9999;

  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
">
  <input id="codeInput" placeholder="Enter code" style="width: 180px;">
  <button onclick="redeemCode()">Enter</button>
</div>
  
<!-- Redeem Result Popup -->
<div id="codeResultPopup" style="
  position: fixed; top: 80px; right: 20px; 
  background: #ffedcc; padding: 12px 20px; border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none;
  z-index: 10000;">
  <span id="codeResultText"></span>
</div>


<div class="card">

  <!-- NAME SETUP -->
  <div id="nameSetup">
    <h1>Welcome â™¡</h1>
    <p>Enter your name:</p>
    <input id="playerNameInput" placeholder="your name">
    <br><br>
    <button onclick="registerName()">Enter</button>
  </div>

<!-- Gacha UI -->
<div id="gachaUI" class="hidden">
  <h1 id="welcomeText"></h1>
  <button onclick="rollGacha()">ðŸŽ° Roll (10 coins)</button>
  <br>
  <button id="historyBtn" onclick="toggleHistory()" style="margin-top:10px; text-decoration:underline; background:none; color:#ff9ecb; border:none; cursor:pointer; font-size:14px;">
    View Gacha History
  </button>
</div>

<!-- History Popup -->
<div id="historyPopup" class="hidden" style="
  position: fixed; top: 100px; left:50%; transform: translateX(-50%);
  background: #fff5fa; padding: 20px; border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 200px; overflow-y:auto;
  z-index: 10000; width: 300px;
">
  <h3 style="margin-top:0;">ðŸ“œ Your Gacha History</h3>
  <div id="historyList"></div>
  <button onclick="closeHistory()" style="margin-top:10px; padding:5px 10px; font-size:14px;">Close</button>
</div>


</div>

<!-- Loading Animation -->
<div id="loading">Rolling...</div>

<!-- Reward Popup -->
<div id="rewardPopup">
  <h2 id="rewardTitle"></h2>
  <img id="rewardImage" src="">
  <br><br>
  <button onclick="closeReward()">Close</button>
</div>

<!-- Cutscene Video -->
<video id="cutsceneVideo" class="hidden" width="80%" height="50%" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);" autoplay></video>

<audio id="rewardSound"></audio>

<script>
// ---------- STATE ----------
const GACHA_COST = 10;
let player = {
  name: "",
  coins: 0,
  history: [],
  stage: "basic",   // basic | memes | lore
  pulls: 0
};

const basicPool = [
  { id:"basic_001", type:"item", name:"Health Potion", rarity:"common", url:"", video:"commonVideo.mp4", sound:"common.mp3" },
  { id:"basic_002", type:"item", name:"Speed Potion", rarity:"common", url:"", video:"commonVideo.mp4", sound:"common.mp3" }
];

const memePool = [
  { id:"meme_001", type:"meme", name:"The Stare", rarity:"common", url:"", video:"commonVideo.mp4", sound:"common.mp3" },
  { id:"meme_002", type:"meme", name:"Cursed Smile", rarity:"rare", url:"", video:"rareVideo.mp4", sound:"rare.mp3" }
];

const lorePool = [
  { id:"lore_001", type:"lore", name:"Golden Ticket", rarity:"legendary", url:"", video:"legendVideo.mp4", sound:"legend.mp3" }
];

const CODE_REWARDS = {
  "freecoins": 30,
  "test123": 50,
  "adminpls": 999
};
// ---------- INIT ----------
loadPlayer();

function loadPlayer() {
  const savedName = localStorage.getItem("currentPlayerName");
  const allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  if (savedName) {
    const savedPlayer = allPlayers.find(p => p.name === savedName);
    if (savedPlayer) {
      player = savedPlayer;
      showGacha();
      return;
    }
  }
  document.getElementById("nameSetup").classList.remove("hidden");
}

function savePlayer() {
  let allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  const idx = allPlayers.findIndex(p => p.name===player.name);
  if(idx>-1) allPlayers[idx]=player;
  else allPlayers.push(player);
  localStorage.setItem("gachaPlayers", JSON.stringify(allPlayers));
  localStorage.setItem("currentPlayerName", player.name);
  updateUI();
}

// ---------- NAME ----------
function registerName() {
  const name = document.getElementById("playerNameInput").value.trim();
  if (!name) return;
  player.name = name;
  player.coins = 50; // start coins
  player.history = [];
  savePlayer();
  showGacha();
}

function showCodeBox() {
  const box = document.getElementById("codeBox");
  box.classList.toggle("hidden"); // toggle visibility
}

function redeemCode() {
  const input = document.getElementById("codeInput").value.trim().toLowerCase();
  if (!input) return;

  if (CODE_REWARDS[input]) {
    player.coins += CODE_REWARDS[input];
    savePlayer();
    updateUI();
    showCodeResult("Redeemed Code â™¡", true);
  } else {
    showCodeResult("Code Not Found âŒ", false);
  }

  document.getElementById("codeInput").value = "";
  document.getElementById("codeBox").classList.add("hidden");
}

function showCodeResult(text, success) {
  const popup = document.getElementById("codeResultPopup");
  const span = document.getElementById("codeResultText");
  span.innerText = text;
  popup.style.background = success ? "#d4f7d4" : "#ffb3b3";
  popup.style.display = "block";

  setTimeout(()=>popup.style.display="none", 2000); // auto-close after 2 sec
}


// ---------- UI ----------
function showGacha() {
  document.getElementById("nameSetup").classList.add("hidden");
  document.getElementById("gachaUI").classList.remove("hidden");
  document.getElementById("welcomeText").innerText = `Hi ${player.name} â™¡`;
  document.getElementById("playerNameDisplay").innerText = player.name;
  updateUI();
}

function updateUI() {
  document.getElementById("coinsDisplay").innerText = `ðŸª™ ${player.coins}`;
  document.getElementById("history").innerHTML = player.history.map(h=>`â€¢ ${h.name} (${h.rarity})`).join("<br>");
}

// ---------- GACHA ----------
function rollGacha() {

  player.pulls++;

  if (player.pulls >= 20 && player.stage === "basic") {
    player.stage = "memes";
    alert("Something feelsâ€¦ unhinged.");
  }
  
  if (player.pulls >= 50 && player.stage === "memes") {
    player.stage = "lore";
    alert("You probably shouldnâ€™t have found this.");
  }

  if(player.coins<GACHA_COST){ alert("Not enough coins!"); return; }
  player.coins -= GACHA_COST;
  updateUI();
  
  const loading = document.getElementById("loading");
  loading.style.display="block";

  const pool = getActivePool();
  const pull = pool[Math.floor(Math.random() * pool.length)];



  // wait 1.5s for "loading" effect
  setTimeout(()=>playCutscene(pull), 1500);
}

// ---------- HISTORY POPUP ----------
function toggleHistory() {
  const popup = document.getElementById("historyPopup");
  const list = document.getElementById("historyList");
  list.innerHTML = player.history.map(h => `â€¢ ${h.name} (${h.rarity})`).join("<br>");
  popup.classList.toggle("hidden");
}

function getActivePool() {
  if (player.stage === "basic") return basicPool;
  if (player.stage === "memes") return [...basicPool, ...memePool];
  return [...basicPool, ...memePool, ...lorePool];
}
  
function closeHistory() {
  document.getElementById("historyPopup").classList.add("hidden");
}

function playCutscene(item) {
  const video = document.getElementById("cutsceneVideo");
  video.src = item.video; // cutscene video for rarity
  video.classList.remove("hidden");
  video.play();

  video.onended = ()=>{
    video.classList.add("hidden");
    showReward(item);
  };
}

function showReward(item) {
  document.getElementById("loading").style.display="none";
  const popup = document.getElementById("rewardPopup");
  document.getElementById("rewardTitle").innerText = item.name;
  document.getElementById("rewardImage").src = item.url;
  
  const sound = document.getElementById("rewardSound");
  sound.src = item.sound;
  sound.play();

  popup.style.display="block";

  player.history.unshift(item);
  savePlayer();
}

function closeReward() {
  document.getElementById("rewardPopup").style.display="none";
}


</script>
</body>
</html>
