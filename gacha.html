<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gacha Room</title>

<style>
  body {
    margin: 0;
    font-family: "Patrick Hand", cursive;
    background: linear-gradient(#ffe6f0, #fff);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* top bar */
  #topBar {
    position: fixed;
    top: 10px;
    right: 15px;
    font-size: 20px;
  }

  /* card */
  .card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    width: 420px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }

  h1 {
    margin-top: 0;
  }

  button {
    font-family: inherit;
    padding: 10px 20px;
    border-radius: 12px;
    border: none;
    background: #ff9ecb;
    cursor: pointer;
    font-size: 16px;
  }

  button:hover {
    background: #ff7fb5;
  }

  input {
    font-family: inherit;
    padding: 8px;
    width: 80%;
    margin-top: 10px;
    border-radius: 10px;
    border: 2px solid #ff9ecb;
    font-size: 16px;
  }

  #result {
    margin-top: 15px;
    font-size: 18px;
  }

  #history {
    margin-top: 20px;
    text-align: left;
    font-size: 14px;
    max-height: 120px;
    overflow-y: auto;
    background: #fff5fa;
    padding: 10px;
    border-radius: 12px;
  }

  .hidden {
    display: none;
  }
</style>
</head>

<body>

<div id="topBar">ðŸª™ <span id="coins">0</span></div>

<div class="card">

  <!-- NAME SETUP -->
  <div id="nameSetup">
    <h1>Welcome â™¡</h1>
    <p>Enter your name:</p>
    <input id="playerNameInput" placeholder="your name">
    <br><br>
    <button onclick="registerName()">Enter</button>
  </div>

  <!-- GACHA -->
  <div id="gachaUI" class="hidden">
    <h1 id="welcomeText"></h1>

    <button onclick="rollGacha()">ðŸŽ° Roll (10 coins)</button>

    <div id="result"></div>

    <h3>ðŸ“œ Gacha History</h3>
    <div id="history"></div>

    <br>
    <input id="codeInput" placeholder="enter code">
    <br><br>
    <button onclick="redeemCode()">Redeem Code</button>
  </div>

</div>

<script>
// ---------- HASH ----------
async function hash(text) {
  const data = new TextEncoder().encode(text);
  const buffer = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(buffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ---------- CONFIG ----------
const GACHA_COST = 10;

// DM CONTROLS THESE
const CODE_REWARDS = {};

// ---------- STATE ----------
let player = {
  name: "",
  coins: 0,
  history: []
};

// ---------- INIT ----------
loadPlayer();

function loadPlayer() {
  // Load all players
  const allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  
  // Check if there is already a saved name in localStorage (one-time name)
  const savedName = localStorage.getItem("currentPlayerName");
  if (savedName) {
    const savedPlayer = allPlayers.find(p => p.name === savedName);
    if (savedPlayer) {
      player = savedPlayer;
      showGacha();
      return;
    }
  }
  // if no saved name, show name setup
  document.getElementById("nameSetup").classList.remove("hidden");
}

function savePlayer() {
  let allPlayers = JSON.parse(localStorage.getItem("gachaPlayers") || "[]");
  const index = allPlayers.findIndex(p => p.name === player.name);
  if(index > -1){
    allPlayers[index] = player;
  } else {
    allPlayers.push(player);
  }
  localStorage.setItem("gachaPlayers", JSON.stringify(allPlayers));
  
  // remember the current player name (so we don't ask again)
  localStorage.setItem("currentPlayerName", player.name);
}

// ---------- NAME ----------
function registerName() {
  const name = document.getElementById("playerNameInput").value.trim();
  if (!name) return;

  player.name = name;
  player.coins = 0;
  player.history = [];

  savePlayer();
  showGacha();
}

function showGacha() {
  document.getElementById("nameSetup").classList.add("hidden");
  document.getElementById("gachaUI").classList.remove("hidden");
  document.getElementById("welcomeText").innerText = `Hi ${player.name} â™¡`;
  updateUI();
}

// ---------- UI ----------
function updateUI() {
  document.getElementById("coins").innerText = player.coins;
  document.getElementById("history").innerHTML =
    player.history.map(h => `â€¢ ${h.name} (${h.type})`).join("<br>");
}

// ---------- GACHA POOL ----------
const gachaPool = [
  // Memes
  { id:"meme_001", type:"meme", name:"The Stare", url:"", description:"It knows what you did." },
  { id:"meme_002", type:"meme", name:"Cursed Smile", url:"", description:"Why is it smiling like that." },
  { id:"meme_003", type:"meme", name:"Low Quality Cat", url:"", description:"Taken on a toaster." },
  // Messages
  { id:"msg_001", type:"message", name:"Motivation Note", url:"", description:"You can do it!" },
  { id:"msg_002", type:"message", name:"Funny Quote", url:"", description:"Laughter is medicine." },
  // Potions
  { id:"potion_health", type:"potion", name:"Health Potion", url:"", effect:"heal" },
  { id:"potion_speed", type:"potion", name:"Speed Potion", url:"", effect:"speed_boost" },
  { id:"potion_night", type:"potion", name:"Night Vision Potion", url:"", effect:"night_mode" },
  // Utility
  { id:"util_key", type:"utility", name:"Magic Key", url:"", description:"Opens hidden things." },
  { id:"util_map", type:"utility", name:"Treasure Map", url:"", description:"Leads to surprises." },
  // Jokes
  { id:"joke_001", type:"joke", name:"Dad Joke", url:"", description:"Why did the chicken cross the road?" },
  { id:"joke_002", type:"joke", name:"Pun Card", url:"", description:"Iâ€™m reading a book on anti-gravity." },
  // Legendary
  { id:"legend_001", type:"legendary", name:"Mystic Orb", url:"", description:"Shiny and rare." },
  { id:"legend_002", type:"legendary", name:"Golden Ticket", url:"", description:"What could it unlock?" }
];

// ---------- GACHA ----------
function rollGacha() {
  if (player.coins < GACHA_COST) {
    document.getElementById("result").innerText = "Not enough coins!";
    return;
  }

  player.coins -= GACHA_COST;

  const pull = gachaPool[Math.floor(Math.random() * gachaPool.length)];

  player.history.unshift(pull);
  document.getElementById("result").innerText = `You got: ${pull.name}`;

  savePlayer();
  updateUI();
}

// ---------- CODES ----------
async function redeemCode() {
  const input = document.getElementById("codeInput").value.trim().toLowerCase();
  if (!input) return;

  const hashed = await hash(input);

  if (CODE_REWARDS[hashed]) {
    player.coins += CODE_REWARDS[hashed];
    document.getElementById("result").innerText = `+${CODE_REWARDS[hashed]} coins â™¡`;
    savePlayer();
    updateUI();
  } else {
    document.getElementById("result").innerText = "Invalid code.";
  }

  document.getElementById("codeInput").value = "";
}
</script>


</body>
</html>
